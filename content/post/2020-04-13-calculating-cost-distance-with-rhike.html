---
title: Estimating hiking velocity with rHike
author: K.B. Vernon
date: '2020-04-13'
slug: estimating-hiking-velocity-with-rhike
categories: []
tags:
  - r
  - sf
  - gdistance
  - rHike
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<p>updated: 05 May 2020</p>
<p>I wanted to learn how to write an R package and I had this recurrent use-case (estimating cost-distance on a grid), so I made <a href="https://github.com/kbvernon/rHike"><code>rHike</code></a>. It’s a super-lightweight package that builds on Jacob van Etten’s <a href="https://agrobioinfoservices.github.io/gdistance/"><code>gdistance</code></a> by implementing both Tobler’s (1993) and Campbell’s (2019) hiking functions, though others could be added. Mainly, it just simplifies the user interface. Development mostly followed the workflow suggested by Hadley Wickham and Jenny Bryan in their <a href="https://r-pkgs.org/">R Packages</a> book. Mostly…</p>
<p><br></p>
<p><em>Where are we going?</em> Intuitively, walking speed should vary as a function of slope. Campbell’s Hiking Function reflects this using an empirically derived version of the Laplace distribution:</p>
<p><span class="math display">\[f(x) = \frac{c}{2b}\, exp\left(\frac{|x - a|}{b}\right) + d + e\, x\]</span></p>
<p>where <span class="math inline">\(x\)</span> is the slope at a location measured in degrees. The idea here is first to get an estimate of slope, then use a hiking function like Campbell’s to calculate velocity, and finally to use velocity to estimate travel time (among other cost-distances).</p>
<pre class="r"><code>slope &lt;- seq(-50, 50, by = 1)

velocity &lt;- hf_campbell(slope, decile = 10)</code></pre>
<p><img src="/post/2020-04-13-calculating-cost-distance-with-rhike_files/figure-html/unnamed-chunk-2-1.png" width="384" style="display: block; margin: auto;" /></p>
<p><br><br></p>
<hr />
<div id="r-preamble" class="section level4">
<h4>R Preamble</h4>
<pre class="r"><code>library(data.table)
library(gdistance)
library(raster)
library(rHike)
library(sf)
library(tidyverse)
library(viridis)</code></pre>
<p><br></p>
<p>Coordinate Reference System (CRS):</p>
<pre class="r"><code>crs_utm12 &lt;- &quot;+init=epsg:26912 +proj=utm +zone=12 +datum=NAD83 +units=m +no_defs&quot;</code></pre>
<p><br></p>
<p>It should really be emphasized that</p>
<blockquote>
<p>the unit of projection should match the unit of the stored values.</p>
</blockquote>
<p>In this case, elevation is in meters, so the projection should be in meters too.</p>
<p><br><br></p>
</div>
<div id="data-wrangling" class="section level4">
<h4>Data Wrangling</h4>
<p>First, we read in a DEM of the foothills in Salt Lake City, Utah:</p>
<pre class="r"><code>dem &lt;- raster(system.file(&quot;extdata/slc.tif&quot;, package = &quot;rHike&quot;))

dem &lt;- projectRaster(dem, crs = crs_utm12)</code></pre>
<p><br></p>
<p>Next we generate an arbitrary point pattern.</p>
<pre class="r"><code>start_points &lt;- st_sf(id = 1:3,
                      typ = &quot;start&quot;,
                      geometry = st_sfc(st_point(c(424350, 4514200)),
                                        st_point(c(426000, 4515000)),
                                        st_point(c(429000, 4516500)),
                                        crs = 26912))

end_points &lt;- st_sf(id = 1:2,
                    typ = &quot;end&quot;,
                    geometry = st_sfc(st_point(c(426200, 4516400)),
                                      st_point(c(427600, 4515600)),
                                      crs = 26912))</code></pre>
<p><br></p>
<p><img src="/post/2020-04-13-calculating-cost-distance-with-rhike_files/figure-html/unnamed-chunk-8-1.png" width="672" style="display: block; margin: auto;" /></p>
<p><br></p>
<p>Now we use the elevation data to generate a slope raster and calculate a velocity surface for the average hiker using Campbell’s Hiking Function.</p>
<pre class="r"><code>slope &lt;- hf_slope(dem)

velocity &lt;- hf_velocity(slope, hf = &quot;campbell&quot;, decile = 10)</code></pre>
<p><br></p>
<p><img src="/post/2020-04-13-calculating-cost-distance-with-rhike_files/figure-html/unnamed-chunk-10-1.png" width="672" style="display: block; margin: auto;" /></p>
<p><br></p>
</div>
<div id="calculating-accumulated-cost" class="section level4">
<h4>Calculating Accumulated Cost</h4>
<p>Accumulated cost-distance is the total time it takes to travel from one location to another; in this case, to <em>all</em> other locations in the landscape of interest.</p>
<pre class="r"><code>cost &lt;- hf_accCost(velocity, 
                   fun = function(x) 1/mean(x), 
                   points = start_points)

# convert seconds to minutes
cost &lt;- cost/60</code></pre>
<p><br></p>
<p><img src="/post/2020-04-13-calculating-cost-distance-with-rhike_files/figure-html/unnamed-chunk-12-1.png" width="672" style="display: block; margin: auto;" /></p>
<p><br></p>
<p>That looks about right, twenty’ish minutes for the average hiker to walk a half-mile or so around the SLC foothills.</p>
<p><br></p>
</div>
<div id="calculating-least-cost-path" class="section level4">
<h4>Calculating Least-Cost Path</h4>
<pre class="r"><code>short_paths &lt;- hf_shortPath(velocity, start_points, end_points)</code></pre>
<p><br></p>
<p><img src="/post/2020-04-13-calculating-cost-distance-with-rhike_files/figure-html/unnamed-chunk-14-1.png" width="672" style="display: block; margin: auto;" /></p>
<p><br><br></p>
</div>
<div id="future-work" class="section level4">
<h4>Future Work</h4>
<p>In this post, conversion between different units was done on the fly. It would be nice to introduce methods to do that in a more rigorous way, so I might look into integrating the <a href="https://r-quantities.github.io/units/"><code>units</code></a> package at some point.</p>
<p><br><br></p>
</div>
<div id="references" class="section level4">
<h4>References</h4>
<p>Tobler, Waldo R. (1993). “Three Presentations on Geographical Analysis and Modeling: Non-Isotropic Geographic Modeling, Speculations
on the Geometry of Geography, and Global Spatial Analysis.”  93-1.</p>
<p>Campbell, Michael J., Philip E. Dennison, Bret W. Butler, and Wesley G. Page (2019). "Using crowdsourced fitness tracker data
to model the relationship between slope and travel rates.  106, 93-107.</p>
</div>
