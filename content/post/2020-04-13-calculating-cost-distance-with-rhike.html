---
title: Estimating hiking velocity with rHike
author: K.B. Vernon
date: '2020-04-13'
slug: estimating-hiking-velocity-with-rhike
categories: []
tags:
  - r
  - sf
  - gdistance
  - rHike
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<p>I wanted to learn how to write an R package and I had this recurrent use-case (estimating cost-distance on a grid), so I made <a href="https://github.com/kbvernon/rHike"><code>rHike</code></a>. It’s a super-lightweight package that builds on Jacob van Etten’s <a href="https://agrobioinfoservices.github.io/gdistance/"><code>gdistance</code></a> by implementing both Tobler’s (1993) and Campbell’s (2019) hiking functions, though others could be added. Mainly, it just simplifies the user interface.</p>
<p>Development mostly followed the workflow suggested by Hadley Wickham and Jenny Bryan in their <a href="https://r-pkgs.org/">R Packages</a> book. Mostly…</p>
<p><code>rHike</code> is not currently on CRAN, but you can install from Github with the following code:</p>
<pre class="r"><code># install.packages(&quot;devtools&quot;)
devtools::install_github(&quot;kbvernon/rHike&quot;)</code></pre>
<p><br></p>
<p><em>Where we are going</em></p>
<p>Campbell’s Hiking Function is an amended version of the Laplace distribution:</p>
<p><span class="math display">\[f(x) = \frac{c}{2b}\, exp\left(\frac{|x - a|}{b}\right) + d + e\, x\]</span></p>
<p>where <span class="math inline">\(x\)</span> is the slope at a location measured in degrees. This equation reflects the intuitive notion that walking speed varies as a function of slope.</p>
<pre class="r"><code>slope &lt;- seq(-50, 50, by = 1)

velocity &lt;- hf_campbell(slope, decile = 10)</code></pre>
<p><img src="/post/2020-04-13-calculating-cost-distance-with-rhike_files/figure-html/unnamed-chunk-2-1.png" width="384" style="display: block; margin: auto;" /></p>
<p><br></p>
<hr />
<div id="r-preamble" class="section level4">
<h4>R Preamble</h4>
<pre class="r"><code>library(gdistance)
library(raster)
library(rHike)
library(sf)
library(tidyverse)
library(viridis)</code></pre>
<p><br></p>
<p>Coordinate Reference System (CRS):</p>
<pre class="r"><code>crs_utm12 &lt;- &quot;+init=epsg:26912 +proj=utm +zone=12 +datum=NAD83 +units=m +no_defs&quot;</code></pre>
<p><br></p>
<p>It should really be emphasized that</p>
<blockquote>
<p>the unit of projection should match the unit of the stored values.</p>
</blockquote>
<p>In this case, elevation is in meters, so the projection should be in meters too.</p>
<p><br></p>
</div>
<div id="data-wrangling" class="section level4">
<h4>Data Wrangling</h4>
<p>First, we read in a DEM of the foothills in Salt Lake City, Utah:</p>
<pre class="r"><code>dem &lt;- raster(system.file(&quot;extdata/slc.tif&quot;, package = &quot;rHike&quot;))

dem &lt;- projectRaster(dem, crs = crs_utm12)</code></pre>
<p><br></p>
<p>Next we generate a random point pattern within it.</p>
<pre class="r"><code>project_window &lt;- dem %&gt;% 
  raster::extent() %&gt;% 
  as(&quot;SpatialPolygons&quot;) %&gt;% 
  st_as_sf() %&gt;% 
  st_cast()

random_points &lt;- st_sample(project_window, size = 5)</code></pre>
<p><br></p>
<p><img src="/post/2020-04-13-calculating-cost-distance-with-rhike_files/figure-html/unnamed-chunk-8-1.png" width="672" style="display: block; margin: auto;" /></p>
<p><br></p>
<p>Now we use the elevation data to generate a slope raster and calculate a velocity surface for the average hiker using Campbell’s Hiking Function.</p>
<pre class="r"><code>slope &lt;- hf_slope(dem)

velocity &lt;- hf_velocity(slope, fun = &quot;campbell&quot;, decile = 10)</code></pre>
<p><br></p>
<p><img src="/post/2020-04-13-calculating-cost-distance-with-rhike_files/figure-html/unnamed-chunk-10-1.png" width="672" style="display: block; margin: auto;" /></p>
<p><br></p>
</div>
<div id="calculating-cost-distance" class="section level4">
<h4>Calculating Cost-Distance</h4>
<p>Accumulated cost-distance is the total time it takes to travel from one location to another; in this case, to <em>all</em> other locations in the landscape of interest.</p>
<pre class="r"><code>cost &lt;- hf_costDistance(velocity, 
                        fun = function(x) 1/mean(x), 
                        points = random_points)

# convert seconds to minutes
cost &lt;- cost/60</code></pre>
<p><br></p>
<p><img src="/post/2020-04-13-calculating-cost-distance-with-rhike_files/figure-html/unnamed-chunk-12-1.png" width="672" style="display: block; margin: auto;" /></p>
<p><br></p>
<p>That looks about right, twenty or so minutes for the average hiker to walk a half-mile or so around the SLC foothills.</p>
<p><br></p>
</div>
<div id="future-work" class="section level4">
<h4>Future Work</h4>
<p>In this post, conversion between different units was done on the fly. It would be nice to introduce methods to do that in a more rigorous way, so I might look into integrating the <a href="https://r-quantities.github.io/units/"><code>units</code></a> package at some point.</p>
<p><br></p>
</div>
<div id="references" class="section level4">
<h4><strong>References</strong></h4>
<p>Tobler, Waldo R. (1993). “Three Presentations on Geographical Analysis and Modeling: Non-Isotropic Geographic Modeling, Speculations
on the Geometry of Geography, and Global Spatial Analysis.”  93-1.</p>
<p>Campbell, Michael J., Philip E. Dennison, Bret W. Butler, and Wesley G. Page (2019). "Using crowdsourced fitness tracker data
to model the relationship between slope and travel rates.  106, 93-107.</p>
</div>
